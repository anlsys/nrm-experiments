- xplaunch_home: $${install_dir}
- xplaunch_user: xprunner
- xplaunch_name: xplaunch
- xplaunch_install_path: $${xplaunch_home}
- xplaunch_libexec_path: $${xplaunch_home}/libexec
- xplaunch_confdir_path: /etc/$${xplaunch_home}/$${xplaunch_name}

#------------------------------------------------------------------------------

- install_dependencies:
  - exec_in: apt-get update --yes
  - exec_in: apt-get install --yes --no-install-recommends python3-cerberus python3-ruamel.yaml hwloc-nox

- create_runner_user:
  - exec_in: useradd --system --no-user-group --groups nix-users --create-home $${xplaunch_user}

- install_python_scripts:
  # main
  - local2in:
    - $${kameleon_data_dir}/xplaunch_main.py
    - $${xplaunch_libexec_path}/$${xplaunch_name}_main.py
  - exec_in: chmod 744 $${xplaunch_libexec_path}/$${xplaunch_name}_main.py
  # static gain
  - local2in:
    - $${kameleon_data_dir}/xplaunch_run_static_gain.py
    - $${xplaunch_libexec_path}/$${xplaunch_name}_run_static_gain.py
  - exec_in: chmod 755 $${xplaunch_libexec_path}/$${xplaunch_name}_run_static_gain.py

- generate_wrapper:
  - write_raw_in:
    - $${xplaunch_install_path}/$${xplaunch_name}
    - |
      #!/bin/bash
      source /etc/profile.d/nix.sh  # bring Nix definitions in shell scope, even with a non-interactive shell
      export XPLAUNCH_CONF='$${xplaunch_confdir_path}/$${xplaunch_name}.conf'
      exec $${xplaunch_libexec_path}/$${xplaunch_name}_main.py "$@"
  - exec_in: chmod 744 $${xplaunch_install_path}/$${xplaunch_name}

- generate_configuration:
  - write_in:
    - $${xplaunch_confdir_path}/$${xplaunch_name}.conf
    - |
      # This file was generated by kameleon during xplaunch step

      hnrm:
        home: $${install_dir}/hnrm-$${hnrm_version}

      xplaunch:
        user: $${xplaunch_user}
        confdir: $${xplaunch_confdir_path}

- install_nix_derivations_of_benchmarks:
  # Algebraic multigrid benchmark (AMG)
  - local2in:
    - $${kameleon_data_dir}/nix/amg.nix
    - $${xplaunch_confdir_path}/amg.nix
  # NAS Parallel Benchmarks
  - local2in:
    - $${kameleon_data_dir}/nix/nas.nix
    - $${xplaunch_confdir_path}/nas.nix
  # STREAM benchmark
  - local2in:
    - $${kameleon_data_dir}/nix/stream.nix
    - $${xplaunch_confdir_path}/stream.nix
