- xpctl_home: $${install_dir}
- xpctl_user: xprunner
- xpctl_name: xpctl
- xpctl_install_path: $${xpctl_home}
- xpctl_libexec_path: $${xpctl_home}/libexec
- xpctl_confdir_path: /etc/$${xpctl_home}/$${xpctl_name}

#------------------------------------------------------------------------------

- install_dependencies:
  - exec_in: apt-get update --yes
  - exec_in: apt-get install --yes --no-install-recommends hwloc-nox python3-pip python3-setuptools python3-wheel

- create_runner_user:
  - exec_in: useradd --system --no-user-group --groups nix-users --create-home $${xpctl_user}

- install_python_scripts:
  - exec_in: mkdir -p $${xpctl_libexec_path}
  # xpctl
  - pipe:
    - exec_local: tar --create --exclude-from=$${kameleon_data_dir}/xpctl/.tarexclude --directory=$${kameleon_data_dir} -- xpctl
    - exec_in: tar --directory=$${xpctl_libexec_path} --extract
  - exec_in: python3 -m pip install --system --editable $${xpctl_libexec_path}/xpctl
  # runners
  - local2in:
    - $${kameleon_data_dir}/runners/identification.py
    - $${xpctl_libexec_path}/runners/identification.py
  - exec_in: chmod 755 $${xpctl_libexec_path}/runners/identification.py

- generate_xpctl_wrapper:
  - write_raw_in:
    - $${xpctl_install_path}/xpctl
    - |
      #!/bin/bash
      # This file was generated by kameleon during xpctl step
      source /etc/profile.d/nix.sh  # bring Nix definitions in shell scope, even with a non-interactive shell
      export XPCTL_CONF='$${xpctl_confdir_path}/xpctl.conf'
      exec xpctl-main "$@"
  - exec_in: chmod 744 $${xpctl_install_path}/xpctl
  - exec_in: ln --symbolic $${xpctl_install_path}/xpctl /usr/sbin/xpctl

- generate_xpctl_configuration:
  - write_in:
    - $${xpctl_confdir_path}/xpctl.conf
    - |
      # This file was generated by kameleon during xpctl step

      version: 2

      hnrm:
        home: $${install_dir}/hnrm-$${hnrm_version}

      xpctl:
        user: $${xpctl_user}
        confdir: $${xpctl_confdir_path}

      runners:
        identification: $${xpctl_libexec_path}/runners/identification.py

- install_nix_derivations_of_benchmarks:
  # xpctl dependencies
  - local2in:
    - $${kameleon_data_dir}/nix/xpctl.nix
    - $${xpctl_confdir_path}/xpctl.nix
  # Algebraic multigrid benchmark (AMG)
  - local2in:
    - $${kameleon_data_dir}/nix/amg.nix
    - $${xpctl_confdir_path}/amg.nix
  # NAS Parallel Benchmarks
  - local2in:
    - $${kameleon_data_dir}/nix/nas.nix
    - $${xpctl_confdir_path}/nas.nix
  # STREAM benchmark
  - local2in:
    - $${kameleon_data_dir}/nix/stream.nix
    - $${xpctl_confdir_path}/stream.nix
